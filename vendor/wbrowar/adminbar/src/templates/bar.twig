{# @var craft \craft\web\twig\variables\CraftVariable #}

{% set devMode = craft.app.config.general.devMode %}

{% import _self as self %}

{# icons #}
{% set assetBundlePath = view.getAssetManager().getPublishedPath('@wbrowar/adminbar/assetbundles/adminbar/dist', true) %}
{% set dashboardPath = assetBundlePath ~ '/img/dashboard.svg' %}
{% set devmodePath = assetBundlePath ~ '/img/devmode.svg' %}
{% set editPath = assetBundlePath ~ '/img/edit.svg' %}
{% set iconPath = assetBundlePath ~ '/img/icon.svg' %}
{% set settingsPath = assetBundlePath ~ '/img/settings.svg' %}

{% if useCss ?? true %}
    {% set css %}
        :root{--adminbar-bg:linear-gradient(to bottom, rgba(0,0,0,0.7), rgba(0,0,0,0.95));--adminbar-color-bg:rgba(0,0,0,0.9);--adminbar-color-border:#505050;--adminbar-color-highlight:#d85b4b;--adminbar-color-link-text:#fff;--adminbar-color-text:rgba(255,255,255,0.8);--adminbar-font-stack:'BlinkMacSystemFont', -apple-system, 'Trebuchet MS', 'Lucida Grande', 'Lucida Sans Unicode', 'Lucida Sans', Tahoma, sans-serif;--adminbar-font-size-mobile:17px;--adminbar-font-size-desktop:14px;--adminbar-height-mobile:52px;--adminbar-height-desktop:45px;--editlinks-bg:var(--editlinks-color-bg);--editlinks-color-bg:var(--adminbar-color-bg);--editlinks-color-border:var(--adminbar-color-border);--editlinks-color-highlight:var(--adminbar-color-highlight);--editlinks-color-link-text:var(--adminbar-color-link-text);--editlinks-color-text:rgba(255,255,255,0.8);--adminbar-logo-links:var(--adminbar-color-highlight);--adminbar-logo-logout:var(--adminbar-color-highlight);--adminbar-logo-pencil:var(--adminbar-color-bg);--adminbar-logo-user:#7e9fc3}.adminbar__icon{display:inline-block;margin-right:7px;width:22px;-webkit-transform:translateY(2px);transform:translateY(2px)}.adminbar__icon svg{width:100%}@media (min-width: 601px){.adminbar .adminbar__icon{margin-right:5px;width:15px}}.adminbar{position:relative;margin:0;padding:0;width:100%;height:var(--adminbar-height-mobile);-webkit-box-sizing:border-box;box-sizing:border-box;background:var(--adminbar-bg);font-family:var(--adminbar-font-stack);font-size:var(--adminbar-font-size-mobile);color:var(--adminbar-color-link-text);-webkit-transition:height .3s ease-out;transition:height .3s ease-out;overflow:hidden;z-index:100000}.adminbar--devmode{padding-top:4px;height:calc(var(--adminbar-height-mobile) + 4px)}.adminbar--sticky{position:fixed;top:0;left:0}.adminbar--widget--on{height:100vh !important}.adminbar__bar{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-flow:row nowrap;flex-flow:row nowrap;-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;height:var(--adminbar-height-mobile)}.adminbar a{margin:0;padding:0 10px;height:100%;text-align:center;text-decoration:none;-webkit-transition:color .2s ease-out, background .2s ease-out;transition:color .2s ease-out, background .2s ease-out}.adminbar a svg *{-webkit-transition:fill .2s ease-out;transition:fill .2s ease-out}.adminbar__devmode_indicator{display:block;position:absolute;top:0;left:0;height:4px;width:100%;background:url("data:image/svg+xml;base64,PHN2ZyBpZD0iTGF5ZXJfMSIgZGF0YS1uYW1lPSJMYXllciAxIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMjguNDcgMjIuOTUiPjxkZWZzPjxzdHlsZT4uY2xzLTF7ZmlsbDojZjNiNjM4fTwvc3R5bGU+PC9kZWZzPjx0aXRsZT5kZXZtb2RlPC90aXRsZT48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik0xODUuNTIgMGgtMTIwTDQyLjk1IDIyLjk1aDEyMEwxODUuNTIgMHoiLz48L3N2Zz4=") repeat-x 15px 0}.adminbar__greeting{display:none;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:0 0 auto;padding:0 15px;color:var(--adminbar-color-link-text);white-space:nowrap}.adminbar--mobile .adminbar__greeting{display:-webkit-box;display:-ms-flexbox;display:flex}.adminbar__user_photo{margin-right:7px;-webkit-box-sizing:border-box;box-sizing:border-box;width:23px;line-height:0}.adminbar__user_photo img{width:23px;max-width:23px;height:auto;border-radius:50%}.adminbar__links_wrapper{display:grid;grid-template-columns:auto auto;grid-template-rows:var(--adminbar-height-mobile);-webkit-box-flex:1;-ms-flex:1 1 auto;flex:1 1 auto;min-width:1px;overflow-x:auto;-webkit-overflow-scrolling:touch;-ms-overflow-style:-ms-autohiding-scrollbar}@media (max-width: 600px){.adminbar--active .adminbar__links_wrapper{overflow:scroll}}.adminbar__widget_buttons{display:-webkit-box;display:-ms-flexbox;display:flex;width:100%;height:100%}.adminbar__widget_button{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-flex:0;-ms-flex:0 0 var(--adminbar-height-desktop);flex:0 0 var(--adminbar-height-desktop);-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;position:relative;-webkit-box-sizing:border-box;box-sizing:border-box;width:var(--adminbar-height-desktop)}.adminbar__widget_button path{fill:var(--adminbar-color-link-text)}.adminbar__widget_button polygon{fill:var(--adminbar-color-link-text)}.adminbar__widget_button rect{fill:var(--adminbar-color-link-text)}.adminbar__widget_button circle{fill:var(--adminbar-color-link-text)}.adminbar__widget_button svg{width:calc(var(--adminbar-height-desktop) - 20px)}.adminbar__widget_button--active{background-color:var(--adminbar-color-highlight)}.adminbar__widget_button__click{position:absolute;top:0;left:0;width:100%;height:100%}.adminbar__links{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-flow:row wrap;flex-flow:row wrap;padding:0}.adminbar--mobile .adminbar__links{display:none}@media (max-width: 600px){.adminbar--mobile .adminbar--active .adminbar__links{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column nowrap;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;padding:40px;min-height:100%;-webkit-box-sizing:border-box;box-sizing:border-box;font-size:1.4em}}.adminbar__links a{-webkit-box-flex:0;-ms-flex:0 0 auto;flex:0 0 auto;color:var(--adminbar-color-link-text)}.adminbar__links a svg path{fill:var(--adminbar-color-link-text)}.adminbar__links a svg polygon{fill:var(--adminbar-color-link-text)}.adminbar__links a svg rect{fill:var(--adminbar-color-link-text)}.adminbar__links a svg circle{fill:var(--adminbar-color-link-text)}.adminbar__logout{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-ms-flex-item-align:end;align-self:flex-end;-webkit-box-orient:vertical;-webkit-box-direction:normal;-ms-flex-flow:column nowrap;flex-flow:column nowrap;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:0 0 auto;padding:0;text-align:right;font-size:.9em}.adminbar__logout a{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-flex:1;-ms-flex:1 1 auto;flex:1 1 auto;padding:9px 25px;background-color:transparent;-webkit-transition:background .2s ease-out, color .2s ease-out;transition:background .2s ease-out, color .2s ease-out;color:var(--adminbar-color-text)}.adminbar__logout a:hover{background-color:var(--adminbar-color-highlight);color:var(--adminbar-color-link-text)}.adminbar--mobile .adminbar__logout_link{display:none}.adminbar__mobile_toggle{display:none;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-flex:1;-ms-flex:1 1 auto;flex:1 1 auto;padding:10px 25px;line-height:1;cursor:pointer}.adminbar__mobile_toggle svg{width:30px}.adminbar__mobile_toggle svg path{fill:var(--adminbar-color-link-text)}.adminbar__mobile_toggle svg polygon{fill:var(--adminbar-color-link-text)}.adminbar__mobile_toggle svg rect{fill:var(--adminbar-color-link-text)}.adminbar__mobile_toggle svg circle{fill:var(--adminbar-color-link-text)}@media (max-width: 600px){.adminbar--mobile .adminbar__mobile_toggle{display:block}}@media (max-width: 600px){.adminbar__overlay.adminbar--active{position:fixed;top:0;left:0;width:100%;height:100%;-webkit-box-sizing:border-box;box-sizing:border-box;background-color:var(--adminbar-color-highlight);overflow:auto;z-index:10}}.adminbar__overlay>.adminbar__close{display:none;position:fixed;top:0;right:0;padding:10px 25px;font-size:1.1em;cursor:pointer}.adminbar__overlay>.adminbar__close svg{width:30px}.adminbar__overlay>.adminbar__close svg path{fill:var(--adminbar-color-link-text)}.adminbar__overlay>.adminbar__close svg polygon{fill:var(--adminbar-color-link-text)}.adminbar__overlay>.adminbar__close svg rect{fill:var(--adminbar-color-link-text)}.adminbar__overlay>.adminbar__close svg circle{fill:var(--adminbar-color-link-text)}.adminbar--devmode .adminbar__overlay>.adminbar__close{top:4px}@media (max-width: 600px){.adminbar__overlay.adminbar--active>.adminbar__close{display:block}}.adminbar_widgets{padding:5vh 5vw;height:calc(100% - 10vh);border-top:1px solid transparent;-webkit-transition:border-color .3s ease-out;transition:border-color .3s ease-out;overflow:hidden}.adminbar--widget--on .adminbar_widgets{border-color:var(--adminbar-color-border)}.adminbar_widgets__content{position:relative;width:100%;height:100%;overflow:scroll}.adminbar_widget{display:grid;grid-gap:30px;grid-template-columns:repeat(auto-fit, minmax(200px, 300px));grid-template-rows:auto;position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;-webkit-transition:opacity .3s ease-out;transition:opacity .3s ease-out}.adminbar_widget--active{opacity:1;z-index:1}.adminbar_widget--template--center{grid-template-columns:[start] auto [content-start] minmax(300px, 900px) [content-end] auto [end];grid-template-areas:". adminbar-widget ."}.adminbar_widget--template--center>*:first-child{grid-area:adminbar-widget}.adminbar_widget--template--columns_12{grid-template-columns:[start] repeat(12, 1fr) [end]}@media (min-width: 601px){.adminbar{font-size:var(--adminbar-font-size-desktop);height:var(--adminbar-height-desktop)}.adminbar--devmode{height:calc(var(--adminbar-height-desktop) + 4px)}.adminbar__bar{height:var(--adminbar-height-desktop)}.adminbar__greeting{display:-webkit-box;display:-ms-flexbox;display:flex;border-right:1px solid var(--adminbar-color-border)}.adminbar__links_wrapper{grid-template-rows:var(--adminbar-height-desktop);-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start}.adminbar__links_wrapper a{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-flow:row nowrap;flex-flow:row nowrap;-webkit-box-align:center;-ms-flex-align:center;align-items:center;height:100%}.adminbar__links_wrapper a:hover{background-color:var(--adminbar-color-link-text);color:var(--adminbar-color-highlight)}.adminbar__links_wrapper a:hover svg path{fill:var(--adminbar-color-highlight)}.adminbar__links_wrapper a:hover svg polygon{fill:var(--adminbar-color-highlight)}.adminbar__links_wrapper a:hover svg rect{fill:var(--adminbar-color-highlight)}.adminbar__links_wrapper a:hover svg circle{fill:var(--adminbar-color-highlight)}.adminbar__widget_buttons{overflow-x:auto;-webkit-overflow-scrolling:touch;-ms-overflow-style:-ms-autohiding-scrollbar}.adminbar__links{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-flow:row nowrap;flex-flow:row nowrap;height:100%}.adminbar--mobile .adminbar__links{display:-webkit-box;display:-ms-flexbox;display:flex}.adminbar__logout{-ms-flex-item-align:stretch;align-self:stretch;font-size:1em}.adminbar__logout a{padding:9px 25px}.adminbar__logout_link{border-left:1px solid var(--adminbar-color-border)}.adminbar--mobile .adminbar__logout_link{display:-webkit-box;display:-ms-flexbox;display:flex}.adminbar--mobile .adminbar__mobile_toggle{display:none}}

        {{ customCss }}
    {% endset %}
    {% do addAdminBarCss(css) %}
{% endif %}

{% if useJs ?? true %}
    {% set js %}
        "use strict";var adminBar=document.getElementById("adminbar"),adminBarWidgetButtons=document.getElementsByClassName("adminbar__widget_button__click"),adminBarWidgets=document.getElementsByClassName("adminbar_widget");function adminBarAddClass(a,t){a.classList?a.classList.add(t):a.className+=" "+t}function adminBarHasClass(a,t){return a.classList?a.classList.contains(t):new RegExp("(^| )"+t+"( |$)","gi").test(a.className)}function adminBarRemoveClass(a,t){a.classList?a.classList.remove(t):a.className=a.className.replace(new RegExp("(^|\\b)"+t.split(" ").join("|")+"(\\b|$)","gi")," ")}function adminBarShowMobile(a){adminBarAddClass(document.querySelector("#adminbar__links .adminbar__overlay"),"adminbar--active")}function adminBarHideMobile(a){adminBarRemoveClass(document.querySelector("#adminbar__links .adminbar__overlay"),"adminbar--active")}function adminBarWidgetButtonHandler(a){var t=adminBar.hasAttribute("data-current-widget")?adminBar.getAttribute("data-current-widget"):null,e=a.target.getAttribute("data-widget-id");console.log(a.target),e===t?adminBarCloseWidgets():adminBarShowWidget(e)}function adminBarCloseWidgets(){var a=document.querySelector(".adminbar__widget_button.adminbar__widget_button--active");void 0!==a&&adminBarRemoveClass(a,"adminbar__widget_button--active"),adminBarRemoveClass(adminBar,"adminbar--widget--on"),adminBar.removeAttribute("data-current-widget")}function adminBarRemoveWidget(a){var t=document.getElementById("adminbar__widget_buttons"),e=document.getElementById("adminbar__widget_button--"+a);t&&e&&t.removeChild(e);var d=document.getElementById("adminbar_widgets__content"),i=document.getElementById("adminbar_widget--"+a);d&&i&&d.removeChild(i)}function adminBarShowWidget(a){var t=void 0,e=void 0;adminBarAddClass(adminBar,"adminbar--widget--on"),adminBar.setAttribute("data-current-widget",a);for(var d=0;d<adminBarWidgets.length;d++)t=document.querySelector('.adminbar__widget_button[data-widget-id="'+adminBarWidgets[d].getAttribute("data-widget-id")+'"]'),e=document.querySelector('.adminbar_widget[data-widget-id="'+adminBarWidgets[d].getAttribute("data-widget-id")+'"]'),a===t.getAttribute("data-widget-id")?(adminBarAddClass(t,"adminbar__widget_button--active"),adminBarAddClass(e,"adminbar_widget--active")):(adminBarRemoveClass(t,"adminbar__widget_button--active"),adminBarRemoveClass(e,"adminbar_widget--active"))}!function(){if(adminBar){document.getElementById("adminbar__mobile_toggle").addEventListener("click",adminBarShowMobile);for(var a=document.querySelectorAll(".adminbar__overlay .adminbar__close"),t=0;t<a.length;t++)a[t].addEventListener("click",adminBarHideMobile);for(var e=0;e<adminBarWidgetButtons.length;e++)adminBarWidgetButtons[e].addEventListener("click",adminBarWidgetButtonHandler);adminBarAddClass(document.documentElement,"adminbar-on")}}();
    {% endset %}
    {% do addAdminBarJs(js) %}
{% endif %}

{#
{% if includeAssets ?? false %}
    <style>{{ css }}</style>
    <script>{{ js }}</script>
{% else %}
    {% if useCss ?? true %}
        {% css css %}
    {% endif %}

    {% if useJs ?? true %}
        {% if js|length %}
            {% js js|raw %}
        {% endif %}
    {% endif %}
{% endif %}
#}

<div id="adminbar" class="adminbar{% if sticky ?? true %} adminbar--sticky{% endif %}{% if devMode %} adminbar--devmode{% endif %}{% if enableMobileMenu ?? true %} adminbar--mobile{% endif %}">
    <div class="adminbar__bar">

        {% if devMode %}
            <div class="adminbar__devmode_indicator"></div>
        {% endif %}

        {% if displayGreeting ?? true %}
            <div class="adminbar__greeting">{% spaceless %}
                {% if currentUser and currentUser.photo %}
                    <span class="adminbar__user_photo">
                        <img src="{{ currentUser.getThumbUrl(50) }}" alt="{{ currentUser.friendlyName }}’s photo"/>
                    </span>
                {% endif %}

                {{ 'Hi'|t }}, {{ currentUser.friendlyName ?? '' }}
            {% endspaceless %}</div>
        {% endif %}

        <div id="adminbar__links" class="adminbar__links_wrapper">
            <div id="adminbar__widget_buttons" class="adminbar__widget_buttons">
                {% if widgets ?? false %}
                    {% for item in widgets %}
                        <a id="adminbar__widget_button--{{ item.id }}" class="adminbar__widget_button" href="javascript:;" title="{{ item.name }}" data-widget-id="{{ item.id }}">{{ svg(item.iconPath) }}<span class="adminbar__widget_button__click" data-widget-id="{{ item.id }}"></span></a>
                    {% endfor %}
                {% endif %}
            </div>
            <div class="adminbar__overlay">
                <nav id="adminbar__links_nav" class="adminbar__links">
                    {% if displayDashboardLink ?? true %}
                        <a href="{{ url(craft.app.config.general.cpTrigger ~ '/dashboard') }}" class="adminbar__has_icon"><span class="adminbar__icon">{{ svg(dashboardPath) }}</span>{{ 'Dashboard'|t }}</a>
                    {% endif %}

                    {% if entry ?? false %}
                        {% set sectionName = entry.section %}
                        {% set entryEditUrl = entry.cpEditUrl %}

                        <a href="{{ url(entryEditUrl) }}" class="adminbar__has_icon"><span class="adminbar__icon">{{ svg(editPath) }}</span>{{ 'Edit '|t ~ sectionName }}</a>
                    {% endif %}

                    {% if category ?? false %}
                        {% set categoryEditUrl = category.cpEditUrl %}

                        <a href="{{ url(categoryEditUrl) }}" class="adminbar__has_icon"><span class="adminbar__icon">{{ svg(editPath) }}</span>{{ 'Edit '|t ~ category }}</a>
                    {% endif %}

                    {% if customLinks|length %}
                        {% for link in customLinks %}
                            {% if link.linkUrl|length %}
                                {% if link.adminOnly != true %}
                                    <a href="{{ url(link.linkUrl) }}">{{ link.linkLabel|t }}</a>
                                {% elseif link.adminOnly and currentUser and currentUser.admin %}
                                    <a href="{{ url(link.linkUrl) }}">{{ link.linkLabel|t }}</a>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}

                    {% for link in additionalLinks %}
                        {{ self.addConfigLink(link) }}
                    {% endfor %}

                    {% if currentUser and currentUser.admin and displaySettingsLink ?? true %}
                        <a href="{{ url(craft.app.config.general.cpTrigger ~ '/settings') }}" class="adminbar__has_icon"><span class="adminbar__icon">{{ svg(settingsPath) }}</span>{{ 'Settings'|t }}</a>
                    {% endif %}
                </nav>
                <div class="adminbar__close">{{ svg(iconPath) }}</div>
            </div>
        </div>
        <div class="adminbar__logout">
            {% if displayLogout ?? true %}
                <a class="adminbar__logout_link" href="{{ url(logoutUrl) }}">{{ 'Sign out'|t }}</a>
            {% endif %}
            {% if enableMobileMenu ?? true %}
                <div id="adminbar__mobile_toggle" class="adminbar__mobile_toggle">{{ svg(iconPath) }}</div>
            {% endif %}
        </div>
    </div>

    {% if widgets ?? false %}
        <div id="adminbar_widgets" class="adminbar_widgets">
            <div id="adminbar_widgets__content" class="adminbar_widgets__content">
                {% for item in widgets %}
                    <div id="adminbar_widget--{{ item.id }}" class="adminbar_widget adminbar_widget__{{ item.id }} adminbar_widget--template--{{ item.layout }}" data-widget-id="{{ item.id }}">
                        {% include item.template ignore missing with {
                            id: item.id,
                            category: category ?? null,
                            entry: entry ?? null,
                            info: item,
                            includeAssets: includeAssets ?? false,
                        } %}
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}

    {% if includeAssets %}
        {{ getAdminBarAssets([], false) }}
    {% endif %}
</div>

{% macro addConfigLink(link) %}
    {% if link.linkParams is defined %}
        {% set params = link.linkParams %}
    {% else %}
        {% set params = '' %}
    {% endif %}

    {% set params = link.params ?? '' %}
    {% set protocol = link.protocol ?? '' %}
    {% set mustShowScriptName = link.mustShowScriptName ?? '' %}

    {% set userHasPermission = true %}
    {% if link.admin is defined and link.admin %}
        {% if currentUser and not currentUser.admin %}
            {% set userHasPermission = false %}
        {% endif %}
    {% elseif link.permissions is defined and link.permissions|length %}
        {% for permission in link.permissions %}
            {% if currentUser and not currentUser.can(permission) %}
                {% set userHasPermission = false %}
            {% endif %}
        {% endfor %}
    {% endif %}

    {% if link.type == 'url' and userHasPermission %}
        <a href="{{ url(link.url, params, protocol, mustShowScriptName) }}">{{ link.title|t }}</a>
    {% elseif link.type == 'cpUrl' and userHasPermission %}
        <a href="{{ url(craft.app.config.general.cpTrigger ~ '/' ~ link.url, params, protocol, mustShowScriptName) }}">{{ link.title|t }}</a>
    {% elseif link.type == 'action' and userHasPermission %}
        {% set actionParams = params|length ? params ~ '&returnUrl=' ~ craft.request.url : 'returnUrl=' ~ craft.request.url %}
        <a href="{{ actionUrl(link.url, actionParams) }}">{{ link.title|t }}</a>
    {% endif %}
{% endmacro %}